# Reading Insights Report Implementation Plan

## Overview
This document outlines the technical implementation for generating personalized "Reading Insights Reports" for users. The report will be generated by Gemini based on the user's reading behavior and quiz performance.

## 1. User Experience & Routing

### New Route
-   **URL**: `/report/:sessionId`
-   **Access**: Public (read-only), similar to `/results/:sessionId`.
-   **Entry Point**: A "Generate My Reading Report" button on the existing Results Page (`/results/:sessionId`).

### Flow
1.  User finishes quiz or visits Results Page.
2.  User clicks "View Detailed Insights" (or similar).
3.  App navigates to `/report/:sessionId`.
4.  **Loading State**: "Analyzing your reading patterns..." (with a fun animation, maybe the spirit animals cycling).
5.  **Result**: The Markdown report is rendered beautifully using a Markdown renderer (e.g., `react-markdown`).

## 2. Architecture & Data Flow

### When is the report generated?
-   **On-Demand (Lazy Generation)**: The report is **not** generated automatically when the user finishes the quiz to save costs and latency.
-   It is generated **only when the user visits the `/report/:sessionId` page** for the first time.
-   **Caching**: Once generated, the Markdown content should be saved to the database so subsequent visits are instant and don't incur Gemini costs.

### How is data fed to Gemini?
1.  **Frontend**: Calls `GET /api/report/:sessionId`.
2.  **Backend (Cloudflare Worker)**:
    *   Checks if a report already exists for this session. If yes, return it.
    *   If no, fetches full `SessionData` (Session, PassageResults, Attempts) from D1 Database.
    *   **Sanitization**: Removes PII (email) but keeps First Name (if available) or uses "Reader".
    *   **Prompt Construction**: Inserts the JSON data into the predefined "Spirit Animal" prompt.
    *   **Gemini Call**: Sends the prompt to Google Gemini via the AI binding.
    *   **Storage**: Saves the generated Markdown response to the database (`sessions` table or new `reports` table).
    *   **Response**: Returns the Markdown to the frontend.

## 3. Technical Components

### Database Changes
-   Add a `reading_report` column (TEXT) to the `sessions` table to cache the generated report.
    -   *Alternative*: Create a separate `reports` table if we expect reports to be large or versioned. For now, a column is sufficient.

### API Endpoint: `GET /api/report/:sessionId`
-   **Logic**:
    ```typescript
    // Pseudo-code
    const session = await db.getSession(sessionId);
    if (session.reading_report) {
      return session.reading_report;
    }
    
    const prompt = constructPrompt(session);
    const report = await gemini.generateContent(prompt);
    
    await db.saveReport(sessionId, report);
    return report;
    ```

### Frontend Component: `ReportPage.tsx`
-   **Dependencies**: `react-markdown`, `remark-gfm` (for tables/formatting).
-   **Styling**:
    -   Use a "paper" or "document" aesthetic.
    -   Large emojis for the Spirit Animal.
    -   Share buttons (Twitter/LinkedIn/Copy Link).

## 4. Prompt Engineering (The "How")

The prompt will be stored in the backend code (`src/prompts/readingReportPrompt.ts`).

**Structure:**
1.  **Context**: "You are an expert reading coach."
2.  **Logic**: "Analyze the JSON below. Calculate First-Attempt Accuracy. Assign one of these animals: [Eagle, Turtle...]."
3.  **Output Format**: "Return ONLY Markdown."
4.  **Data**: `JSON.stringify(sessionData)`

## 5. Security & Privacy
-   **PII**: Ensure `email` is NOT sent to Gemini. Only send performance metrics and reading patterns.
-   **Rate Limiting**: Ensure the `/api/report` endpoint is rate-limited to prevent abuse.

## 6. Implementation Steps
1.  [ ] **DB**: Add `reading_report` column to `sessions` table.
2.  [ ] **Backend**: Create `src/utils/reportGenerator.ts` (Prompt logic).
3.  [ ] **Backend**: Create endpoint `functions/api/report/[id].ts`.
4.  [ ] **Frontend**: Create `src/components/ReportPage.tsx`.
5.  [ ] **Frontend**: Add link/button in `ResultsPage.tsx`.
